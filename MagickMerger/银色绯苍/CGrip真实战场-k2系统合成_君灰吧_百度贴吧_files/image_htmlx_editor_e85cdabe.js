_.Module.define({path:"common/component/image_htmlx_editor",requires:["common/component/image_uploader"],sub:{initial:function(a){this.options=$.extend({dialogWidth:650,dialogHeight:460,asideWidth:165,imgMaxWidth:1600,title:"\u7f8e\u5316\u56fe\u7247"},a);this.dialog=null;this.container=null;this.main=null;this.aside=null;this.viewer=null;this._message=null;this._footer=null;this._cancelButton=null;this._restartButton=null;this._submitButton=null;this._buildDialog();this._imgWrapperClass="j_htmlxImageWrapper";this._imgWrapper=null;this._imgMask=null;this._buildImgWrapper();this.canvas=null;this.preCanvas=null;this.context=null;this.preContext=null;this._canvasStack=[];this._initCanvas();this._enterButton=null;this._initEnterButton();this._bindEvent();this.imgNode=null;this._zoom=1;this._pluginList=[];this._imgList={};this._source={};this._locked=false},_buildDialog:function(){this.container=$('<div class="xeditor_ctn"></div>');var a=$('<div class="xeditor_wraper"></div>').appendTo(this.container);this.main=$('<div class="xeditor_main clearfix"></div>').appendTo(a);this.aside=$('<div class="xeditor_aside clearfix"><dl class="xeditor_tools"><dt class="switch_title"><a class="selected j_switch">\u57fa\u672c\u64cd\u4f5c</a><a class="">\u7f8e\u5316</a></dt><dd class="switch_content"><ul class="xeditor_handle selected"><li class="xeditor_clip">\u88c1\u526a</li><li class="xeditor_rl">\u5de6\u65cb\u8f6c</li><li class="xeditor_rr">\u53f3\u65cb\u8f6c</li></ul><ul class="xeditor_filter"></ul></dd></dl></div>').appendTo(a);this.viewer=$('<div class="xeditor_viewer"></div>').appendTo(this.main);this._message=$('<span class="xeditor_message"><img src="/tb/static-common/img/editor/loading.gif" /><span></span></span>').appendTo(this.viewer);this._footer=$('<div class="xeditor_btns"><a href="#" class="cancel" onclick="return false;">&nbsp</a><a href="#" class="ui_btn ui_btn_m j_btnOk" onclick="return false;"><span><em>\u786e\u8ba4</em></span></a><a href="#" class="restart" onclick="return false;">\u91cd\u65b0\u5f00\u59cb</a>').appendTo(this.container);this._cancelButton=this._footer.find(".cancel");this._restartButton=this._footer.find(".restart");this._submitButton=this._footer.find(".j_btnOk");this.dialog=new $.dialog({title:this.options.title,html:this.container[0],holderClassName:"xeditor_dialog",width:this.options.dialogWidth,height:this.options.dialogHeight,show:false,hideOnclose:true,fixed:false,draggable:false});this.dialog.showTitle=true;this._setContainerSize()},_buildImgWrapper:function(){this._imgWrapper=$('<div class="'+this._imgWrapperClass+'" contenteditable="false" style="position: relative;display:inline-block;"></div>');this._imgMask=$("<div style=\"position:absolute;border: 1px solid gray;display: table-cell;text-align: center;vertical-align: middle;background-color: rgba(0,0,0,.3);filter:progid:DXImageTransform.Microsoft.gradient(enabled='true',startColorstr='#4C000000', endColorstr='#4C000000');\"></div>").appendTo(this._imgWrapper)},_setContainerSize:function(){var b=this.options.dialogHeight-this._footer.outerHeight();this.aside.css({width:this.options.asideWidth,height:b});this.main.css({width:this.options.dialogWidth-this.aside.outerWidth()-parseInt(this.main.css("padding-left"))*2-2,height:b-parseInt(this.main.css("padding-left"))*2});var a=this.aside.find(".switch_content");a.css({height:b-35})},_initCanvas:function(){this.canvas=document.createElement("canvas");this.preCanvas=document.createElement("canvas");this.viewer.append(this.preCanvas);this.context=this.canvas.getContext("2d");this.preContext=this.preCanvas.getContext("2d")},clearCanvas:function(){this.viewer[0].removeChild(this.preCanvas);this.canvas=null;this.preCanvas=null;this.context=null;this.preContext=null;this._initCanvas()},_initEnterButton:function(){var a=this;this._enterButton=$('<a contenteditable="false" href="#" class="xeditor_enter_btn1" onclick="return false;"></a>').appendTo(this._imgWrapper);this._enterButton.on("click",function(b){a.showDialog()})},_bindEvent:function(){var b=this,c=this.aside.find(".switch_title a"),d=this.aside.find(".switch_content"),a=this.aside.find(".xeditor_filter");c.each(function(e){$(this).on("click",function(f){c.removeClass("selected");$(this).addClass("selected");$(d.find("ul").hide().get(e)).show()})});this._imgWrapper.on("mouseleave",function(){b.hideButton();if(b.richEditor){b.richEditor.editorPlugins.draft.save()}});this._cancelButton.bind("click",function(){b.dialog.hide()});this._restartButton.bind("click",function(){if(confirm("\u91cd\u65b0\u5f00\u59cb\u5c06\u64a4\u9500\u6240\u6709\u6b65\u9aa4\u5e76\u6062\u590d\u5230\u539f\u56fe\uff0c\u60a8\u786e\u5b9a\u5417\uff1f")){b.restart();$.stats.sendRequest("st_mod=htmlximgeditor&fr=tb0_forum&st_value=restart")}});this._submitButton.bind("click",function(){if(!b.isLocked()){b._submit()}});a.bind("mousewheel",function(g){var f=g.originalEvent;if(f.wheelDelta){f.preventDefault();d[0].scrollTop-=f.wheelDelta}})},showDialog:function(){this.dialog.show();this.dialog.setPosition();this.restart();this.dialog.modal.element.height(this.dialog.modal.height());$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=dialogshow")},restart:function(){if(!this.pluginLoded){this.addPlugin("clip","image_htmlx_editor/clip");this.addPlugin("rotate","image_htmlx_editor/rotate");this.addPlugin("filter","image_htmlx_editor/filter");this.pluginLoded=true}this.drawMainCanvas();this.drawPreCanvas();for(var a in this._pluginList){this._pluginList[a].trigger("restart")}this.releaseLock();this.hideMessage()},drawMainCanvas:function(){var b=this._source.data;if(b.width>this.options.imgMaxWidth){var e=b.height/b.width;b.width=this.options.imgMaxWidth;b.height=this.options.imgMaxWidth*e}var d=b.width,a=b.height,c=this.canvas;c.width=d;c.height=a;this.context.drawImage(b,0,0,d,a);this.pushOperation("drawMain",c)},drawPreCanvas:function(){var d=this.canvas,e=d.width,b=d.height,g=this.viewer.width(),a=this.viewer.height(),c=this.preCanvas;var f=e/b;if(e>g&&f>=1){c.width=g;c.height=c.width/f}else{if(b>a&&f<1){c.height=a;c.width=c.height*f}else{c.width=d.width;c.height=d.height}}this._zoom=e/c.width;this.preContext.drawImage(d,0,0,c.width,c.height);this.setPreCanvasPosition()},setPreCanvasPosition:function(){var c=this.viewer.width(),a=this.viewer.height(),b=this.preCanvas;$(this.preCanvas).css({left:~~((c-b.width)/2),top:~~((a-b.height)/2)})},pushOperation:function(a,c){var b=c.cloneNode();b.getContext("2d").drawImage(c,0,0);this._canvasStack.push({operation:a,canvas:b});this.trigger("change",{operation:a})},getLastOperation:function(a,d){for(var c=this._canvasStack.length-1;c>=0;c--){var b=this._canvasStack[c];if((b.operation!=a)==d){return b}}return this._canvasStack[0]},setSource:function(b,a){this._source.data=b;$.extend(this._source,a);return this},setCanvas:function(b){var a=b.cloneNode();a.getContext("2d").drawImage(b,0,0);this.canvas=null;this.context=null;this.canvas=a;this.context=a.getContext("2d")},clip:function(e){var a=Math.round(e.x*this._zoom),f=Math.round(e.y*this._zoom),b=Math.round(e.width*this._zoom),d=Math.round(e.height*this._zoom);a=a>0?a:0;f=f>0?f:0;if(a+b>this.canvas.width){b-=a+b-this.canvas.width}if(f+d>this.canvas.height){d-=f+d-this.canvas.height}var c={x:a,y:f,width:b,height:d};this._clipCanvas(this.canvas,c);this.pushOperation("clip",this.canvas);this.drawPreCanvas();$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=clip")},_clipCanvas:function(b,c){var a=b.getContext("2d"),d=a.getImageData(c.x,c.y,c.width,c.height);a.clearRect(0,0,b.width,b.height);b.width=c.width;b.height=c.height;a.putImageData(d,0,0)},_submit:function(){this.showMessage("\u6b63\u5728\u4e0a\u4f20\uff0c\u8bf7\u7a0d\u540e...");this.addLock("submit");var a=$.ajax({url:"http://tieba.baidu.com/dc/common/imgtbs",dataType:"json"});self=this;a.done(function(d){if(Number(d.no)===0){var b="http://upload.tieba.baidu.com/upload/pic?tbs="+d.data.tbs+(self._source.isWater?"&is_wm=1":""),e=self.use("common/component/image_uploader",b),c=self.canvas.cloneNode();c.getContext("2d").drawImage(self.canvas,0,0);e.bind("success",function(g,h,f){self._upEnd(f,c)});e.setVariable(self._source.variable);e.upload(self.canvas,1024*1024*2)}else{self.richEditor.setStatsRequest("tbsgeterror")}}).fail(function(){self.richEditor.setStatsRequest("tbsgeterror")});$.stats.sendRequest("fr=tb0_forum&st_mod=htmlximgeditor&st_value=imgupload")},_upEnd:function(i,c){var g=i.info.pic_id_encode,b=i.info.fullpic_width,h=i.info.fullpic_height,f=i.info.pic_water,e=this.imgNode,d=TED.EditorCore.defaultConfig.imageWidthLimit,a;if(!this._source.isWater&&!g){this.showMessage("\u4e0a\u4f20\u56fe\u7247\u5931\u8d25",true,2000);this.canvas=c;this.releaseLock();return false}if(this._source.isWater&&f){a=f}else{a="http://imgsrc.baidu.com/forum/pic/item/"+g+".jpg"}this.trigger("end",a,b,h);this.addImage(a,c,{isWater:this._source.isWater});if(!e){return}e.width=b;e.height=h;if(b>d){e.width=d;$(e).removeAttr("height");$(e).attr("changedsize",true)}else{$(e).removeAttr("changedsize")}e.src=a;this.dialog.hide();this.imgNode=null},addPlugin:function(b,c){var a=this,d;_.Module.use("common/component/"+c,[this],function(e){a._pluginList[b]=e;e.trigger("add_to_editor_success")})},addLock:function(a){this._locked=true;this._locker=a},releaseLock:function(){this._locked=false},isLocked:function(){return this._locked},showMessage:function(e,c,f){this._message.find("span").html(e);this._message.find("img")[c?"hide":"show"]();var g=this.viewer,a=this._message.outerWidth(),d=this._message.outerHeight();this._message.css({left:(g.width()-a)/2,top:(g.height()-d)/2}).show();if(f){var b=this;setTimeout(function(){b.hideMessage()},f)}},hideMessage:function(){this._message.hide()},addImage:function(b,c,a){this._imgList[b]={sourceData:c,options:a||{}}},addDelegateContainer:function(b,a){var c=this;this._imgContainer=$(b);this._imgSelector=a;this.clearAllButton();$(b).delegate(a,"mouseover",function(d){if(c.richEditor){clearInterval(c.richEditor.editorPlugins.draft.timer)}c.detectImage(this)}).delegate(a,"mouseout",function(d){}).css("position","relative")},setRichEditor:function(b){this.richEditor=b;var a=this;$(b.editArea).on("scroll",function(c){if(a.isButtonVisible()){a.setButtonPosition()}})},detectImage:function(c){var f=c.src;if(!this._imgList[f]){return}if(c.width<120||c.height<120){return}if(this.imgNode===c){this.showButton();return}this.imgNode=c;var e=this._imgList[f],d=e.sourceData,b=this;if(d.size){var a=new FileReader();a.onload=function(h){a.onload=null;_dataURI=h.target.result;var g=new Image();g.src=_dataURI;g.onload=function(){b.setSource(g,e.options);b.showButton();delete g}};a.readAsDataURL(d)}else{if(typeof d=="string"){var c=new Image();c.src=d;c.onload=function(){b.setSource(c,e.options);b.showButton();delete c}}else{if(/canvas/i.test(d.toString())){this.setSource(d,e.options);this.showButton()}}}},showButton:function(){if(this.isButtonVisible()){this.setButtonPosition();return false}this._imgWrapper.find("img").remove();var a=$(this.imgNode);a.before(this._imgWrapper);this._imgWrapper.append(a).css({width:a.outerWidth(true),height:a.outerHeight(true)});var c={left:this.imgNode.offsetLeft,top:this.imgNode.offsetTop},b={width:a.width(),height:a.height()};this._imgMask.css({top:c.top-1,left:c.left-1,width:b.width,height:b.height});this.setButtonPosition()},setButtonPosition:function(){var e=$(this.imgNode);var b=this._enterButton,d=this._imgWrapper.position(),h={width:e.width(),height:e.height()},g={width:b.width(),height:b.height()},c;var f=this.richEditor.editArea,j=d.top<0?-d.top:0,i=f.clientHeight,a;if(d.top<0){a=h.height-j;a=Math.min(a,i)}else{a=i-d.top;a=Math.min(a,h.height)}c={left:h.width/2-g.width/2,top:j+a/2-g.height/2};this._enterButton.css({display:"block",top:c.top,left:c.left})},isButtonVisible:function(){return jQuery.contains(this._imgWrapper[0],this.imgNode)},hideButton:function(){if(!this.imgNode){return}var a=this;this.imgNode.parentNode.removeChild(this.imgNode);this._imgWrapper.after(this.imgNode);this._imgWrapper[0].parentNode.removeChild(this._imgWrapper[0])},clearAllButton:function(){var a=this._imgSelector;this._imgContainer.find("."+this._imgWrapperClass).each(function(c,d){var e=$(d);if(e.find(a).length){var b=e.find(a)[0];b.parentNode.removeChild(b);e.after(b)}d.parentNode.removeChild(d)})}}});