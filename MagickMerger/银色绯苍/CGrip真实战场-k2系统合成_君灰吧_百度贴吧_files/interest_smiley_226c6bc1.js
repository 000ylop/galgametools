_.Module.define({path:"common/component/InterestSmiley",requires:["common/component/PostorService","common/component/image_water","common/component/ScrollPanel"],sub:{path:"http://static.tieba.baidu.com/tb/editor/images/",_imgWaterPath:"http://tieba.baidu.com/tb/editor/images/",smileTip:{qw_x:["\u6ca1\u56feBS","\u4e0d\u660e\u89c9\u5389","\u778e\u4e86\u72d7\u773c","\u5751\u7239","\u4e0d\u4f1a\u7231","\u8eba\u67aa","\u767d\u5bcc\u7f8e","\u4e0d\u670d\u6765\u8fa9","\u5bf9\u4e0d\u8d77"],qw_cat:["catsoul\u5d29\u6e83\u5730\u8bf4\uff1a\u76f4\u5230\u6211\u819d\u76d6\u4e2d\u4e86\u4e00\u7bad","catsoul\u53d1\u75af\u8bf4\uff1a\u6211\u64e6","catsoul\u574f\u7b11\u5730\u8bf4\uff1a\u4f60\u61c2\u7684","catsoul\u5978\u7b11\u8bf4\uff1a\u8fd9\u771f\u662f\u6781\u597d\u7684","catsoul\u7cbe\u795e\u5730\u8bf4\uff1a\u7ed9\u529b\uff01","catsoul\u7ea0\u7ed3\u5730\u8bf4\uff1a\u4f60\u59b9","catsoul\u54ed\u8bf4\uff1a\u611f\u89c9\u4e0d\u4f1a\u518d\u7231\u4e86","catsoul\u8c03\u76ae\u8bf4\uff1a\u697c\u4e0b\u600e\u4e48\u770b\uff1f","catsoul\u6deb\u7b11\u8bf4\uff1a\u5475\u5475"]},smileTextTip:{qw_x:["\u6ca1\u56fe\u4f60\u8bf4\u4e2axx","\u4e0d\u660e\u89c9\u5389","\u778e\u4e86\u72d7\u773c","\u5751\u7239","\u611f\u89c9\u4e0d\u4f1a\u518d\u7231\u4e86","\u8eba\u7740\u4e5f\u4e2d\u67aa","\u767d\u5bcc\u7f8e","\u4e0d\u670d\u6765\u8fa9","\u5bf9\u4e0d\u8d77"],qw_cat:["\u76f4\u5230\u6211\u819d\u76d6\u4e2d\u4e86\u4e00\u7bad","\u6211\u64e6","\u4f60\u61c2\u7684","\u8fd9\u771f\u662f\u6781\u597d\u7684","\u7ed9\u529b\uff01","\u4f60\u59b9","\u611f\u89c9\u4e0d\u4f1a\u518d\u7231\u4e86","\u697c\u4e0b\u600e\u4e48\u770b\uff1f","\u5475\u5475"]},smileNum:{qw_x:9,qw_cat:9},smilePrev:{qw_x:"qw_x_00",qw_cat:"qw_cat_00"},smileSmallPath:{qw_x:"qw_x",qw_cat:"qw_cat_small"},smileQueen:["qw_cat","qw_x"],smileBrowse:{qw_x:"qw_x_browse",qw_cat:"qw_cat_browse"},smileTemplate:{qw_x:"qw_x_template",qw_cat:"qw_cat_template"},_dialogShow:false,_layerShow:false,isValueChange:true,_isPosting:false,_width:200,_height:200,version:"?20130427",initial:function(c){var b={type:"editor",smileClass:"t_smile_bg",scrollBar:"",scrollCss:{padding:"0px"},scrollBarHide:function(){return},scrollBarShow:function(){return},container:"",dataPostor:{}};var a=this;this.option=$.extend(true,b,c);this.manager();this.postorService=this.use("common/component/PostorService");this.wrapper=$(".wrap2");this.bindPostor();this._imageW=this.use("common/component/image_water");this._imageW.bind("onComplete",function(g,k){var h=k.response;var e=h.info.pic_id_encode,f=h.info.fullpic_width,d=h.info.fullpic_height,i=h.info.pic_water,j="http://imgsrc.baidu.com/forum/pic/item/"+e+".jpg";a.postorHandler(j,a._textValue,"configSmile",a._width,a._height);a._progessBar(100,140);a._isPosting=false});this._imageW.bind("onError",function(e,f){a._isPosting=false;var d={image:'<img style="border:none;" src="http://static.tieba.baidu.com/tb/img/errorFace.gif">',subMessage:"\u53d1\u8d34\u5931\u8d25",message:f.errorMessage,dialogSet:{width:410,height:95,title:"\u53d1\u8868\u8d34\u5b50"}};a._showErrorTip(d,function(){return true})});this._imageW.bind("onProgressListen",function(d,e){a.loading.show();a.dBtn.hide();setTimeout(function(){a._progessBar(e.percent,140)},200)})},_progessBar:function(c,a){var d=c*a/100;var b=this;b.loading.find(".s_progress_bar").width(d)},bindPostor:function(){var a=this;this.postorService.bind("onCheckEroor",function(){a.trigger("onsuccess");a.destroyLayer()});this.postorService.bind("onError",function(){a.trigger("onsuccess");a.destroyLayer();a.dBtn.show();a.loading.hide()})},manager:function(){if(window.InterestSmileyManager){window.InterestSmileyManager.push(this)}else{window.InterestSmileyManager=[];window.InterestSmileyManager.push(this)}},generic:function(){this.render("qw_cat");this.eventInit()},render:function(e){var d=this.option,c=this;var a=d.container;var b=c._gSmile(e);$.JsLoadManager.use("/tb/static-common/lib/jquery-ui-1.10.0.draggable.min.js?v=130307102247",function(){c.scrollPanel=c.use("common/component/ScrollPanel",{container:a,padding:c.option.scrollCss.padding,height:193,scrollBarHide:c.option.scrollBarHide,scrollBarShow:c.option.scrollBarShow,content:b})})},_gSmile:function(n){var l=this.option;var o=this,c="";if(n=="all"){var k=o.smileQueen;for(var f=0,m=k.length;f<m;f++){var a=k[f],h=o.smileNum[a],d=o.smilePrev[a],e=l.smileClass;for(var g=1;g<=h;g++){var b=o.path+"qw_review/"+o.smileyName(d,g,"png");c+='<div class="s_image '+e+'" data-type="'+a+'" title="'+o.smileTip[a][g-1]+'"    data-num="'+g+'"><img src="'+b+'" /></div>'}}}else{var a=n,h=o.smileNum[a],d=o.smilePrev[a],e=l.smileClass;for(var g=1;g<=h;g++){var b=o.path+"qw_review/"+o.smileyName(d,g,"png");c+='<div class="s_image '+e+'" data-type="'+a+'" title="'+o.smileTip[a][g-1]+'"     data-num="'+g+'"><img src="'+b+'" /></div>'}}return c},smileyName:function(d,b,c){var a="";a=d;if(b<10){a=a+"0"}a=a+b+"."+c;return a},shake:function(h,c,e,b){var d=h,f=this.wrapper;this.Timer=setTimeout(g,c);var a=this;function g(){if(d>=0){f.css({padding:0});if(d%2==0){f.css({paddingLeft:a.easeInOut(0,b,d,e)})}else{f.css({paddingRight:a.easeInOut(0,b,d,e)})}d--;a.Timer=setTimeout(g,c)}else{clearTimeout(a.Timer)}}},easeInOut:function(e,a,d,c){var b=d/c*2;return(b<1?Math.pow(b,3):((b-=2)*Math.pow(b,2)+2))*a/2+e},destroyLayer:function(){var a=this;if(a.layer&&a._layerShow==true){clearTimeout(a.Timer);$(".wrap2").css("padding",0);a.layer.stop();a.layer.hide();a._layerShow=false}if(a.dialog&&a._dialogShow){a.dialog.hide();a._dialogShow=false}if(a.imageText){a.imageText.hide();a.imageText.html("")}},eventInit:function(){var c=this.option;var a=this.option.container,b=this;a.delegate(".s_image","click",function(){var l=$(this);var o=l.data("type"),h=l.data("num");var f=b.smilePrev[o];var d=b.path+b.smileBrowse[o]+"/"+b.smileyName(f,h,"gif");b.trigger("click");var s=$(document).height(),k=$(window),r=k.height()/2-300,m=k.width()/2-500,q="fixed",n=m+270;var e=window.InterestSmileyManager;for(var g=0,j=e.length;g<j;g++){e[g].destroyLayer()}if($.browser.msie&&$.browser.version<7){r=$(window).scrollTop();q="absolute"}if(b.imageText){b.imageText.hide()}var p=$.getzIndex();if(b.layer){b.layer.attr("src",d+b.version);b.layer.css({width:1000,height:1000,top:r,zIndex:p,left:m,position:q,opacity:0.1});b.layer.attr("data-type",o);b.layer.attr("data-num",h);b.layer.attr("data-isTemplate","no");b.layer.show();b._layerShow=true}else{b.layer=$('<img src="'+d+b.version+'" data-type="'+o+'" data-isTemplate="no" data-num="'+h+'" style="width:1000px;height:1000px;top:'+r+"px;z-index:"+p+";opacity:0.1;left:"+m+"px;position:"+q+';" >');$("body").append(b.layer);b._layerShow=true}b.layer.animate({width:400,height:400,opacity:1,left:n},500,function(){if(!($.browser.msie&&$.browser.version<7)){if($.browser.msie){b.shake(20,30,12,3)}else{if($.getBrowser().name=="sougou"){b.shake(20,25,16,4)}else{b.shake(20,25,12,3)}}}b.renderDialog(r,n)});$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=interestS&st_value="+c.type)})},_fTip:{isBlock:"\u60a8\u5df2\u7ecf\u88ab\u5c01\u7981\uff0c\u4e0d\u80fd\u53d1\u8d34",balv:' <a href="http://tieba.baidu.com/f/like/level?kw=d8" >4\u7ea7\u5934\u8854</a><br />\u4ee5\u4e0a\u4f1a\u5458\u53d1\u8d34\u3002',old:"\u62b1\u6b49\uff0c\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53ca\u6ce8\u518c\u6ee1\u4e00\u5b9a\u65f6\u95f4\u7684\u8001\u7528\u6237\u53d1\u8d34",bawu:"\u62b1\u6b49\uff0c\u672c\u5427\u76ee\u524d\u4ec5\u9650\u5427\u52a1\u56e2\u961f\u53d1\u8d34",law:"\u62b1\u6b49\uff0c\u6839\u636e\u76f8\u5173\u6cd5\u5f8b\u6cd5\u89c4\u548c\u653f\u7b56\uff0c\u672c\u5427\u76ee\u524d\u53ea\u80fd\u6d4f\u89c8\uff0c\u4e0d\u80fd\u53d1\u8d34"},cannotPost:function(c){var b=this;b.trigger("onsuccess");b.destroyLayer();switch(c){case"login":_.Module.use("common/component/LoginDialog",["","editor"]);return;break;case"noUn":TbCom.process("User","buildUnameFrame","\u586b\u5199\u7528\u6237\u540d"," ");return;break}var d="\u60a8\u4e0d\u80fd\u8fdb\u884c\u53d1\u8d34\u64cd\u4f5c";if(c!=""){d=this._fTip[c]}var a={image:'<img style="border:none;" src="http://static.tieba.baidu.com/tb/img/errorFace.gif">',subMessage:"\u53d1\u8d34\u5931\u8d25",message:d,dialogSet:{width:410,height:95,title:"\u53d1\u8868\u8d34\u5b50"}};b._showErrorTip(a,function(){return true})},_showErrorTip:function(a,d){var b='<div style="margin: 0px 30px 0px 30px;font-size:14px;line-height:20px;text-align:left;font-family: "\u5b8b\u4f53";"><table style="width:90%"><tbody><tr><td width="60">'+a.image+'</td><td valign="middle" style="font-size:20px;line-height:22px;font-family: "\u9ed1\u4f53";">'+a.subMessage+"</td></tr></tbody></table>"+a.message+"</div>";var c=$.dialog.alert(b,a.dialogSet);c.bind("onclose",d)},postorHandler:function(a,b,g,i,f){var d=this.postorService,j=this;var c=this.option.dataPostor;var e=j._getData(a,g,b,i,f);d.postHandler({data:e,type:"reply",success:j.successCallback,context:j,error:j.errorCallback,captchaCloseCallback:function(){j.destroyLayer()}})},_getData:function(a,i,b,k,f){var c=this.option.dataPostor;var d=this.postorService,l=this;var e=$.extend(true,{},c.data);e.content=d.genericRich({type:i,src:a,width:k,height:f,text:$.tb.escapeHTML(b)});e.anonymous=0;var g=document.getElementById("sign_id");var j=document.getElementById("useSignName");if(j&&j.checked&&g){e.sign_id=g.value}return e},successCallback:function(b,a){a.trigger("onsuccess");a.destroyLayer();a.showSuccessTip()},errorCallback:function(d,b,c){var a=this},showSuccessTip:function(){var b=$(document).height(),e=$(window),a=e.scrollTop()+e.height()/2-50,c=e.width()/2-100,f=$.getzIndex();var d=$('<div style="position:absolute;z-index:'+f+'"><div class="editor_banned_tip_info"><span class="postor_success"></span><span style="">\u53d1\u8868\u6210\u529f!</span></div><div>');d.css({top:a,left:c});d.appendTo($("body"));setTimeout(function(){d.fadeOut(300,function(){d.remove()})},1500)},addBubble:function(b){var c=this;if(c.bubble){return}var d={content:"\u529f\u80fd\u5373\u5c06\u4e0a\u7ebf\uff0c<br>\u656c\u8bf7\u671f\u5f85~",arrow_dir:"down",bubble_css:{top:0,left:50,width:100},arrow_pos:{left:45},attr:"  ",wrap:b,closeBtn:false,level:1,arrowReq:true};var a=new UiBubbleTipBase(d);a.j_bubble.find(".j_content").css({backgroundColor:"white",border:"1px solid #848482",textAlign:"center"});a.j_bubble.find(".ui_triangle_outter").css({color:"#848482"});a.j_bubble.find(".ui_triangle_inner").css({color:"white"});c.bubble=a},_submit:function(){var f=this.postorService,k=this;if(k._isPosting){return}k._isPosting=true;var e=this.option.dataPostor;var g=f.isCanPost(e.canPostor);if(g.canPost){var i=k.layer;var j=i.attr("data-type"),h=i.attr("data-num"),c=k.textInput.val().trim();k._textValue=c;var d=k.smilePrev[j];var b=k._imgWaterPath+k.smileTemplate[j]+"/"+k.smileyName(d,h,"gif");if(c==""||c==k.smileTextTip[j][h-1]){var a=k.path+k.smileSmallPath[j]+"/"+k.smileyName(d,h,"gif");k.postorHandler(a,c,"smiley",k._width,k._height);k._isPosting=false}else{k._imageWater(b,c,k.textStyle[j][h-1]);$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=interestS&st_value=zidingyi")}}else{var j=g.type;k.cannotPost(j);k._isPosting=false}},_imageWater:function(e,d,f){var a=this;var b=a.filterStyle(d,f);var c={imageUrl:e+a.version,text:{content:d,x:f.x,y:f.y,width:f.width},font:{size:b.size,lineHeight:b.lineHeight,color:f.color,family:"\u5fae\u8f6f\u96c5\u9ed1"}};if(a._imageW){a._imageW.merge(c);return}},textStyle:{qw_x:[{x:180,y:158,width:148,height:126,lineHeight:32,color:"#ffffff",size:14},{x:60,y:155,width:170,height:95,lineHeight:24,color:"#557E90",size:14},{x:212,y:166,width:130,height:86,lineHeight:20,color:"#ffffff",size:14},{x:246,y:127,width:90,height:125,lineHeight:19,color:"#ffffff",size:14},{x:45,y:155,width:180,height:80,lineHeight:20,color:"#557E90",size:14},{x:45,y:164,width:178,height:70,lineHeight:18,color:"#ffffff",size:14},{x:222,y:102,width:130,height:107,lineHeight:21,color:"#557E90",size:14},{x:85,y:145,width:150,height:100,lineHeight:25,color:"#ffffff",size:14},{x:51,y:122,width:160,height:90,lineHeight:25,color:"#557E90",size:14}],qw_cat:[{x:181,y:40,width:180,height:122,lineHeight:32,color:"#000000",size:24},{x:160,y:46,width:195,height:115,lineHeight:30,color:"#000000",size:24},{x:155,y:43,width:201,height:118,lineHeight:30,color:"#000000",size:24},{x:55,y:66,width:303,height:85,lineHeight:30,color:"#000000",size:24},{x:143,y:56,width:208,height:104,lineHeight:26,color:"#000000",size:24},{x:140,y:55,width:217,height:123,lineHeight:28,color:"#000000",size:24},{x:190,y:40,width:179,height:132,lineHeight:33,color:"#000000",size:24},{x:60,y:73,width:300,height:85,lineHeight:28,color:"#000000",size:24},{x:131,y:47,width:212,height:124,lineHeight:31,color:"#000000",size:24}]},filterStyle:function(a,c){var d=a.length,h=c.lineHeight,j=c.size,f=c.width,i=this,e={lineHeight:c.lineHeight,size:c.size};if(d>0){var b=c.height*c.width,g=b/d;e.lineHeight=Math.ceil(Math.pow(g,0.5));e.size=Math.ceil(e.lineHeight*1.5/2.5)}if(e.lineHeight>c.height){e.lineHeight=c.height}if(e.lineHeight<c.lineHeight){e.lineHeight=c.lineHeight}if(e.size<c.size){e.size=c.size}return e},showSmileTemplate:function(n,j,m){var o=this;var e=o.layer;var k=e.attr("data-type"),d=e.attr("data-num"),b=o.smilePrev[k],c=e.attr("data-isTemplate");var a=o.path+o.smileTemplate[k]+"/"+o.smileyName(b,d,"gif"),f=o.textStyle[k][d-1];var i=function(p){var q=o.textInput.val();if(o.imageText){o.imageText.html($.tb.escapeHTML(q));o.imageText.css(p);o.imageText.show();return}o.imageText=$('<div class="s_image_text"></div>');o.imageText.html($.tb.escapeHTML(q));o.imageText.css(p);$("body").append(o.imageText);o.imageText.show()};var l="fixed";if($.browser.msie&&$.browser.version<7){l="absolute"}var h=o.filterStyle(o.textInput.val(),f);var g={position:l,zIndex:m,width:f.width,lineHeight:h.lineHeight+"px",left:f.x+j,fontSize:h.size,color:f.color,fontFamily:"\u5fae\u8f6f\u96c5\u9ed1",top:f.y+n};if(c=="yes"){i(g)}else{e.attr("src",a+o.version);e.attr("data-isTemplate","yes");i(g)}},renderDialog:function(a,g){var d=this;var b=d.layer;var c=b.attr("data-type"),f=b.attr("data-num"),e=d.smileTextTip[c][f-1];d.sTop=a;d.sL=g;if(d.imageText){d.imageText.hide()}if(d.dialog){d.dialog.setPosition(g,a+400);d.dialog.element.css({zIndex:$.getzIndex()});d.loading.find(".s_progress_bar").width(0);d.dBtn.show();d.loading.hide();d.zIndex=$.getzIndex();d.isValueChange=false;d.textInput.val(e);d.dialog.show();d._dialogShow=true;return}d.zIndex=$.getzIndex();d.textInput=$('<input value="'+e+'" class="s_text_input"/>');d.replyBtn=$('<a href="#" style="float:left;" class=" ui_btn ui_btn_m"><span><em>\u53d1\u8868\u56de\u590d</em></span></a>');d.cancelBtn=$('<a class="qw_cancel"></a>');d.dBtn=$('<div style="position:relative;margin-left:9px;">').append(d.textInput).append(d.replyBtn).append(d.cancelBtn);d.loading=$('<div class="s_loading_wrap"><div class="s_progress_w"><span class="s_progress_bar"></span></div><div class="s_loading_tip">\u5ba2\u5b98\u7a0d\u7b49\u4e0b\uff0c\u6211\u4eec\u6b63\u5728\u52aa\u529b\u4e3a\u60a8\u751f\u6210\u56fe\u7247\u4e2d<div></div>');d.dContent=$("<div></div>").append(d.dBtn).append(d.loading);d.replyBtn.click(function(h){d._submit();h.preventDefault();h.stopPropagation();$.stats.sendRequest("st_mod=editor&fr=tb0_forum&st_type=interestS&st_value=send")});d.textInput.focus(function(){var h=$(this);setTimeout(function(){d._isSelect=true;h.select()},10)});d.textInput.bind("mousedown",function(){d._isSelect=false});$.subInput(d.textInput,30);d.textInput.keydown(function(i){var j=i||window.event;if(j.keyCode==13){d._submit();return false}var h=$.tb.getByteLength(d.textInput.val());if(d._isSelect&&h>39){d.textInput.val("")}d._isSelect=false;d.showSmileTemplate(d.sTop,d.sL,d.zIndex);return true});d.textInput.bind("input",function(){if(d.isValueChange){d.showSmileTemplate(d.sTop,d.sL,d.zIndex)}d.isValueChange=true;return true});d.textInput.bind("propertychange",function(){if(d.isValueChange){d.showSmileTemplate(d.sTop,d.sL,d.zIndex)}d.isValueChange=true;return true});d.cancelBtn.click(function(){d.trigger("onCancel");d.destroyLayer()});d.dialog=new $.dialog({html:d.dContent,modal:false,escable:false,showTitle:false,top:a+400,left:g,closeable:true,fixed:true,autoCenter:false,width:420,height:30,draggable:false,closeable:false});d._dialogShow=true}}});