_.Module.define({path:"common/component/image_uploader_manager",requires:["common/component/image_uploader_manager/uploader_flash","common/component/image_uploader_manager/uploader_html5"],sub:{initial:function(a){var b={container:null,width:200,height:50,isAutoUp:false,queueLen:10,needWatermark:false,fid:"",maxSize:3*1024*1024,maxWidth:3000,maxHeight:3000,uploadUrl:"http://upload.tieba.baidu.com/upload/pic",getUploadParams:null,tbsUrl:"http://tieba.baidu.com/dc/common/imgtbs",isFlash:false};this._options=$.extend(b,a||{});this.uploader=null;this.EVENTS=["onFileSelected","onStartUpload","onProgressListen","onComplete","onError"];this._reset()},_initUploadUrl:function(c){var a=this;if(this._options.uploadUrl.indexOf("tbs")>0){c&&c.apply(a);return}var b=$.ajax({url:this._options.tbsUrl,dataType:"json"});b.done(function(d){if(Number(d.no)===0){a._options.uploadUrl+=("?tbs="+d.data.tbs+(a._options.isWater?"&is_wm=1":"")+"&fid="+(a._options.fid||""));c&&c.apply(a)}else{c&&a._error()}}).fail(function(){c&&a._error()})},_reset:function(){var a=navigator.userAgent.toLowerCase().match(/chrome\/([\d]+)/);if(!((a&&parseInt(a[1])>=21)||$.browser.mozilla)){this._options.isFlash=true}this._initUploadUrl(this._startImageUploader)},_startImageUploader:function(){if(!this._options.isFlash){if(this._options.container){this.uploader=this.use("common/component/image_uploader_manager/uploader_html5",this._options)}}else{this.uploader=this.use("common/component/image_uploader_manager/uploader_flash",this._options)}if(this._options.container){this._generateCallBack()}},_generateCallBack:function(){var b=this;for(var c=0;c<this.EVENTS.length;c++){var a=this.EVENTS[c];this.uploader.bind(a,(function(d){return function(g,f){b.trigger(d,f||g)}})(a))}},start:function(){this.uploader.start()},startUpload:function(){this.uploader.start()},stop:function(){this.uploader.stop()},stopUpload:function(){this.uploader.stop()},deleteFile:function(a){this.uploader.deleteFile(a)},clearList:function(){this.uploader.clearList()},reUploadError:function(a){this.uploader.resetErrorStatus(a)},uploadBase64:function(a,c){var b=this;if(this._options.isFlash){this._flashUploadBase64(a,c)}else{this._initUploadUrl(function(){b._ajaxUploadBase64(a,c)})}},_ajaxUploadBase64:function(a,c){var b=this;$.ajax({url:b._options.uploadUrl+"&_token="+(new Date()).getTime(),data:{filetype:"base64",file:a},type:"POST",success:function(d){c.call(b,{errorCode:0,errorMessage:"",response:d})},error:function(d){c.call(b,{errorCode:1,errorMessage:"\u4e0a\u4f20\u5931\u8d25",response:d})},dataType:"json"})},_flashUploadBase64:function(a,c){var b=this;if(this.uploader&&this.uploader.uploader.uploadBase64){this.uploader.uploadBase64(a,c)}else{setTimeout(function(){b._flashUploadBase64(a,c)},100)}},_error:function(a){a=$.extend({percent:0,errorCode:400,errorMessage:"\u521d\u59cb\u5316\u51fa\u9519",imageList:{}},a||{});this.trigger("onError",a)}}});