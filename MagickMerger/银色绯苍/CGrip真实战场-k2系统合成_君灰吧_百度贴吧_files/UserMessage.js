var initItiebaMessage;new (function(){TbICom.call(this);var a="";var D=[];var c;var d;var I;var U;var p;var i={atme:0,light:0,reply:0,favts:0,recycle:0};var w="default";var L=false;var B={all_msg:{id:0,display:true,aside_tip_id:"",url:""},fans:{id:1,url:"#itb_home#&type=fans",aside_tip_id:"",display:true},evaluate:{id:2,url:"#itb_home#&type=my_evaluate",aside_tip_id:"new_evaluate_num_tip",display:true},wealth:{id:3,url:"",display:true},reply:{id:4,url:"#itb_home#&type=replyme",aside_tip_id:"new_reply_num_tip",display:true},feature:{id:5,url:"#itb_home#&type=feature",aside_tip_id:"new_feature_num_tip",display:true},guess:{id:6,url:"#itb_home#&type=main",aside_tip_id:"new_guess_num_tip",display:true},postPasser:{id:8,display:false},atme:{id:9,url:"#itb_home#&type=atme",aside_tip_id:"new_atme_num_tip",display:true},recycle:{id:10,url:"#itb_home#&type=recycle",aside_tip_id:"new_recycle_num_tip",display:true},invite:{id:11,url:"#itb_home#",aside_tip_id:"new_invite_num_tip",display:true},light:{id:12,url:"#itb_home#&type=light",aside_tip_id:"new_light_num_tip",display:true},favts:{id:20,url:"#itb_home#&type=storethread",aside_tip_id:"new_storethread_num_tip",display:true}};var t={itb_home:""};var P=function(Z,X){d=Z;I=X||$("body");var Y=TbCom.process("MsgSystem","getIsReady");if(Y){h()}else{TbCom.addEvent("MsgSystem","ready",function(){h()})}};var h=function(){if(L){return}if(d!="itieba"){a="_blank"}var X=TbCom.process("User","getUserInfo");if(!X||!X.is_login||!X.portrait){TbCom.process("User","getUserInfoByRequest",M)}else{M(X)}L=true};var M=function(X){c=X.portrait;t.itb_home="/i/sys/jump?u="+c;for(var Y in B){D[B[Y]["id"]]=Y}for(var Z in B){var aa=B[Z];if(typeof aa.url!="undefined"){switch(Z){case"guess":B[Z]["url"]=aa.url.replace(/#itb_home#/g,"/i/app/"+Z+"?uc="+c);break;case"invite":B[Z]["url"]=aa.url.replace(/#itb_home#/g,"/f/i/invite");break;default:B[Z]["url"]=aa.url.replace(/#itb_home#/g,"/i/sys/jump?u="+c)}}}f();TbCom.addEvent("MsgSystem","sys_message",N);TbCom.addEvent("MsgSystem","listenComplete",b);H()};var f=function(){var ad=D;var X=[];X.push('<div style="clear:both;"><ul>');for(var aa=0,Y=ad.length;aa<Y;aa++){X.push('<li id="message_'+ad[aa]+'" style="display:none;"></li>')}X.push("</ul>");X.push('<div class="tb_msg_tip_rightpanel">');X.push('<a href="'+t.itb_home+'&type=profile#notify" style="height:100%;" target="_self" class="setting">设置</a>');X.push('<a title="关闭" href="#" onclick="TbCom.process(\'UserMessage\',\'clearAllData\');return false" class="close_msg_tip"></a>');X.push('<b style="clear:both; text-align:left;"></b>');X.push("</div></div>");var ac=$("#com_userbar").find(".u_ucenter>div"),ag=ac.offset().left,ae=ag?ag:0,Z=$("body").width();_right=Z-ae-160,_right=_right>350?180:_right;var ab={content:X.join(""),arrow_dir:"up",bubble_css:{right:_right,width:170},arrow_pos:{left:30},level:2,attr:" id='tb_message_tip_n' ",wrap:I};var af=new UiBubbleTipBase(ab);af.setFixedForMessage();U=af.j_bubble;p=af;$("#mobile_promote_download").bind("click",function(){_.Module.use("common/component/diversionDialog",[],function(ah){ah.showDiversionDialog("webtbnews")})})};var r=function(X){TbCom.process("MsgSystem","doSomethingAfterReady",function(){X()})};var H=function(){var Y="http://message.tieba.baidu.com/i/msg/get_data";var X=Y+"?user="+c;$.JsLoadManager.use(X)};var n=function(X){r(function(){if(X!="favts"){W(X);e(X)}else{m()}})};var W=function(aa){var Z=new Date().getTime();var ab=B[aa]["id"];if(ab!==20){var Y="http://message.tieba.baidu.com/i/msg/clear_data?type="+ab+"&user="+c+"&stamp="+Z;var X=new Image();window["itieba_msg_clearer_"+Z]=X;X.src=Y}};var y=function(){r(function(){for(var X in B){if(X!="all_msg"){W(X)}}l()})};var V=function(){var Y=new Date().getTime();var X="/tsmg?query=get_data&uid="+c+"&stamp="+Y;$.get(X,function(Z){if(Z&&Z.no==0){g(Z.data.ret);K()}},"json")};var m=function(){var Y=new Date().getTime();var X="/tsmg?query=clear_data&uid="+c+"&stamp="+Y;$.get(X,function(Z){if(Z&&Z.no==0){g(0);K()}},"json")};var Q=function(X){var Y=X.join(",");V();C(Y);TbCom.process("MsgSystem","sendMsg","other","sys","all_msg",Y,"default",null,false)};initItiebaMessage=Q;var e=function(X){r(function(){if(!X||X==""){return}TbCom.process("MsgSystem","sendMsg","all","sys",X,"0","default",null,false)})};var l=function(){TbCom.process("MsgSystem","sendMsg","all","sys","clear_msg","all","default",null,false);TbCom.process("MsgSystem","removeMsgByMod","sys","command_listen");m()};var v=function(){var X="/f?ct=486539264&cm=59202&tn=jsonUserInfo&t="+Math.random();$.get(X,{},function(Y){var Z=$.json.decode(Y);if(Z.beans_num){TbCom.process("MsgSystem","sendMsg","all","sys","wealth",Z.beans_num,"default",null,false);setTimeout(function(){W("wealth");TbCom.process("MsgSystem","removeMsg","sys","wealth")},100)}})};var b=function(ab,aa){var Z=aa.mod;var X=D[aa.msg.type];var Y=aa.msg.cnt;if(Z=="sys"&&X=="wealth"){v();return}TbCom.process("MsgSystem","sendMsg","all",Z,X,Y,"default",null,false)};var N=function(aa,Z){if(!Z){$.console.debug("@UserMessage _renderMsg : 不需要处理！")}else{var Y=Z.type,X=Z.content;if(Y&&typeof X!="undefined"){q(Y,X)}else{$.console.debug("@UserMessage _renderMsg : 返回的数据中没有type和content")}}};var q=function(X,Y){switch(X){case"all_msg":C(Y);break;case"fans":u(Y);break;case"evaluate":E(Y);break;case"wealth":s(Y);break;case"reply":k(Y);K();break;case"feature":T(Y);break;case"guess":O(Y);break;case"atme":F(Y);K();break;case"light":S(Y);K();break;case"invite":J(Y);break;case"favts":g(Y);break;case"recycle":z(Y);K();break;case"clear_msg":R(Y);break;default:$.console.debug("@UserMessage _renderMsgHandler; LCF返回的消息没有处理函数");break}};var u=function(Y){var X=parseInt(Y);if(X>0){G("fans",X,"新粉丝")}else{A("fans")}};var E=function(aa){var Z=parseInt(aa);var X=$("#new_evaluate_num_tip");var Y="";if(Z>0){G("evaluate",Z,"新评价");Y="("+aa+"新)"}else{A("evaluate")}if(X){X.html(Y)}};var s=function(aa){var Y=parseInt(aa);var Z=w;if(Y>0){if(typeof Z=="string"&&(Z=="add_post")){TbCom.process("WealthSystem","postTipSetDisplay",true)}else{var X='<div class="tb_beans_msg_tip">恭喜你，贴吧豆增收啦！<br />当前总数：<span class="tb_beans_num_tip"><b>'+aa+"</b></span>个</div>"}}};var T=function(aa){var Z=parseInt(aa);var X=$("#new_feature_num_tip");var Y="";if(Z>0){G("feature",Z,"新精品");Y="("+aa+"新)"}else{A("feature")}if(X){X.html(Y)}};var k=function(Y){var X=parseInt(Y);i.reply=X;if(X>0){G("reply",X,"新回复")}else{A("reply")}};var K=function(){var Z=i.reply+i.atme+i.light+i.recycle;if(Z>0){var X=$("#new_reply_num_tip");var Y="";Y="("+Z+"新)";if(X){X.html(Y)}}else{var X=$("#new_reply_num_tip").html("")}};var g=function(aa){var Z=parseInt(aa);i.favts=Z;if(Z>0){var X=$("#new_storethread_num_tip");var Y="";Y="("+Z+"贴有更新)";if(X){X.html(Y)}G("favts",Z,"收藏贴有更新");$.stats.sendRequest("fr=tb0_forum&st_mod=msgsys&st_type=favtshow")}else{A("favts")}};var z=function(Y){var X=parseInt(Y);i.recycle=X;if(X>0){G("recycle",X,"回收站提醒")}else{A("recycle")}};var O=function(Y){var X=parseInt(Y);if(X>0){G("guess",X,"竞猜结果")}else{A("guess")}};var J=function(Y){var X=parseInt(Y);i.invite=X;if(X>0){G("invite",X,"粉丝福利卡")}else{A("invite")}};var F=function(Y){var X=parseInt(Y);i.atme=X;if(X>0){G("atme",X,"@提到我")}else{A("atme")}};var S=function(Y){var X=parseInt(Y);i.light=X;if(X>0){G("light",X,"点亮我")}else{A("light")}};var R=function(ae){var ad=U;var ac=ad.find("li");for(var ab=0,Y=ac.length;ab<Y;ab++){$(ac[ab]).css("display","none")}ad.css("display","none");var X=null;var aa="";for(var Z in B){aa=B[Z]["aside_tip_id"];if(typeof aa=="string"&&aa!=""){X=$("#"+aa);if(X){X.html("");X.css("display","none")}}}};var C=function(ad){var ac=ad.split(",");var aa=D;var ab=aa.length-1;var Y;for(var Z=0,X=ac.length;Z<X;Z++){num=ac[Z];if(Z<ab){Y=aa[Z+1];q(Y,num)}}};var j=function(ae){var ad=U;var ac=U.find("li");for(var ab=0,Y=ac.length;ab<Y;ab++){$(ac[ab]).css("display","none")}if(p){p.hideBubble()}var X=null;var aa="";for(var Z in B){aa=B[Z]["aside_tip_id"];if(typeof aa=="string"&&aa!=""){X=$("#"+aa);if(X){X.html("");X.css("display","none")}}}};var o=function(X){w=X};var G=function(ac,Z,ae){var ag=$("#message_"+ac)||null;var aa=B[ac];if(aa.display==false||!ag){return}var ad=aa.id;var X=aa.url;var af="st_mod="+ac+"_tip&fr=tb0_"+d;var ab=$("<span>"+Z+"个</span>");var Y=$("<a>"+ae+"</a>");Y.attr({href:X,target:a});Y.bind("click",function(){n(ac);$.stats.sendRequest(af)});ag.html("");ag.append(ab);ag.append(Y);ag.css("display","block");if(p){p.showBubble()}$("#u_xiangce").find(".j_wrap").hide()};var A=function(aa){var Y=$("#message_"+aa);var ac=U;var ab=ac.find("li");Y.css("display","none");var ad=true;for(var Z=0,X=ab.length;Z<X;Z++){if($(ab[Z]).css("display")!="none"){ad=false;break}}ac.css("display",ad?"none":"block")};var x=function(Y,X){if(!Y||!(Y in B)){return}B[Y]["display"]=!!(X)};this.initSys("UserMessage",["User","MsgSystem","WealthSystem"],{init:P,clearSysMsg:e,clearData:n,clearAllData:y,setWealthActionType:o,setMsgDisplay:x})})();